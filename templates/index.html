<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/vs2015.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --bg-darker: #252526;
            --bg-light: #333333;
            --accent: #007acc;
            --text-main: #d4d4d4;
            --border: #444;
        }
        
        body { margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; height: 100vh; display: flex; background: var(--bg-dark); color: var(--text-main); overflow: hidden; }

        /* ledt sidebar*/
        #sidebar { width: 250px; background: var(--bg-darker); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 15px; font-weight: bold; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; color: #888; border-bottom: 1px solid var(--border); }
        #problem-list { flex: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #555 transparent; }
        
        .problem-item { padding: 8px 15px; cursor: pointer; font-size: 13px; border-left: 3px solid transparent; transition: all 0.1s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #ccc; }
        .problem-item:hover { background: #2a2d2e; color: white; }
        .problem-item.active { background: #37373d; border-left-color: var(--accent); color: white; }

        /*download icon (green tick) */
        .status-icon {
            display: inline-block;
            width: 20px;
            color: #4caf50;
            font-weight: bold;
        }

        /*main area */
        #main { flex: 1; display: flex; flex-direction: column; min-width: 0; }


        #header { height: 50px; background: var(--bg-light); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid var(--border); }
        #problem-title { font-size: 16px; font-weight: 600; margin: 0; }
        .btn-group { display: flex; gap: 10px; }
        .btn { padding: 6px 14px; border: none; border-radius: 2px; cursor: pointer; font-size: 12px; font-weight: 600; transition: opacity 0.2s; color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-blue { background: var(--accent); }
        .btn-green { background: #4caf50; }
        .btn-orange { background: #ce9178; }
        .btn:hover:not(:disabled) { opacity: 0.9; }

        /* Ccontent split (top/bottom) */
        #content-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        /* DESCRIPTION (top) */
        #description-panel { flex: 1; padding: 20px; overflow-y: auto; border-bottom: 1px solid var(--border); }
        #description-panel h1, #description-panel h2 { font-size: 1.2em; color: white; margin-top: 0; }
        #description-panel pre { background: #2d2d2d; padding: 10px; border-radius: 4px; overflow-x: auto; }
        #description-panel code { font-family: 'Consolas', monospace; background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 3px; font-size: 0.9em; }

        /* BOTTOM PANEL (the 2 tabs) */
        #bottom-panel { height: 35%; display: flex; flex-direction: column; background: var(--bg-dark); }
        .tabs { display: flex; background: var(--bg-darker); border-bottom: 1px solid var(--border); }
        .tab { padding: 8px 20px; cursor: pointer; font-size: 12px; text-transform: uppercase; color: #888; border-top: 2px solid transparent; }
        .tab:hover { color: white; }
        .tab.active { color: white; border-top-color: var(--accent); background: var(--bg-dark); }
        
        .tab-content { flex: 1; overflow-y: auto; padding: 0; display: none; }
        .tab-content.active { display: block; }

        /* the console (on the bottom) */
        #console-output { padding: 15px; font-family: 'Consolas', monospace; font-size: 13px; white-space: pre-wrap; line-height: 1.5; color: #ccc; }

        /* Solutiin view */
        #solution-container { height: 100%; overflow: hidden; background: var(--bg-dark); position: relative; }
        #solution-view { margin: 0; height: 100%; padding: 0; overflow: auto; }
        
        #solution-code { 
            display: block;
            white-space: pre !important; /* Forces newlines */
            font-family: 'Consolas', 'Monaco', monospace; 
            padding: 20px;
            font-size: 13px;
            line-height: 1.5;
            min-height: 100%;
        }
        
        .blur-overlay { display: flex; align-items: center; justify-content: center; height: 100%; background: rgba(0,0,0,0.5); position: absolute; top: 0; left: 0; width: 100%; }
    
        #problem-search:focus {
            outline: 1px solid var(--accent);
            border-color: var(--accent);
        }

        #problem-search::placeholder {
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header">Problems</div>
        <div style="padding: 10px; border-bottom: 1px solid var(--border);">
            <input type="text" id="global-search" placeholder="Search 3000+ problems..." 
                style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box;">
        </div>
        <div id="problem-list">
            <div style="padding: 20px; color: #888; font-size: 12px;">Initializing problem set...</div>
        </div>
    </div>

    <div id="main">
        <div id="header">
            <h2 id="problem-title">Select a problem</h2>
            <div class="btn-group">
                <button id="btn-open" class="btn btn-blue" onclick="openVSCode()" disabled>Open VS Code</button>
                <button id="btn-run" class="btn btn-green" onclick="runTests()" disabled>Run Tests</button>
            </div>
        </div>

        <div id="content-area">
            <div id="description-panel">
                <p style="color: #666; text-align: center; margin-top: 50px;">Select a problem from the sidebar.</p>
            </div>

            <div id="bottom-panel">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('console')">Testcase & Console</div>
                    <div class="tab" onclick="switchTab('solution')">Community Solution</div>
                </div>

                <div id="console-tab" class="tab-content active">
                    <div id="testcase-container" style="padding: 10px; border-bottom: 1px solid var(--border); background: var(--bg-darker);">
                        <div id="testcase-tabs" style="display: flex; gap: 5px; margin-bottom: 10px; overflow-x: auto;">
                            <button onclick="addTestCase()" style="background: #333; color: white; border: 1px solid #444; padding: 2px 8px; cursor: pointer;">+</button>
                        </div>
                        <div id="testcase-inputs">
                            </div>
                    </div>
                    <div id="console-output">// Test results will appear here...</div>
                </div>

                <div id="solution-tab" class="tab-content">
                    <div id="solution-container">
                        <div class="blur-overlay" id="solution-overlay">
                            <button class="btn btn-orange" onclick="revealSolution()">Click to Reveal Solution</button>
                        </div>
                        <pre id="solution-view" style="display:none;"><code class="language-python" id="solution-code"></code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>



        
        let currentSlug = null;
        let currentFilepath = null;
        let testCases = []; 
        let activeTestCaseIndex = 0;
        let argCount = 0;

        async function loadProblem(slug, element) {
            
            document.querySelectorAll('.problem-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');

            document.getElementById('problem-title').innerText = "Loading...";
            document.getElementById('description-panel').innerHTML = "<p>Loading...</p>";
            document.getElementById('console-output').innerText = "";
            
            document.getElementById('btn-open').disabled = true;
            document.getElementById('btn-run').disabled = true;
            
            try {
                const response = await fetch(`/api/load/${slug}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                currentSlug = slug;
                currentFilepath = data.filepath;
                
                argCount = data.arg_count || 1; 

                const rawLines = data.testcases_raw.trim().split('\n').filter(l => l.trim());
                testCases = groupTestCases(rawLines, argCount); 
                
                activeTestCaseIndex = 0;

                document.getElementById('problem-title').innerText = data.title;
                document.getElementById('description-panel').innerHTML = data.content;
                
                document.getElementById('btn-open').disabled = false;
                document.getElementById('btn-run').disabled = false;

                renderTabs();
                renderInputs();
            } catch (err) {
                document.getElementById('description-panel').innerHTML = `<p style="color:#ff6b6b">Error: ${err.message}</p>`;
            }
        }

        function groupTestCases(lines, count) {
            const grouped = [];
            for (let i = 0; i < lines.length; i += count) {
                const chunk = lines.slice(i, i + count).map(line => {
                    try { return JSON.parse(line); } 
                    catch { return line; }
                });
                if (chunk.length === count) grouped.push(chunk);
            }
            return grouped;
        }
        function renderTabs() {
            const container = document.getElementById('testcase-tabs');
            const plusBtn = `<button onclick="addTestCase()" style="background: #333; color: white; border: 1px solid #444; padding: 2px 8px; cursor: pointer;">+</button>`;
            
            let html = "";
            testCases.forEach((_, i) => {
                const activeStyle = (i === activeTestCaseIndex) ? "color: white; border-bottom: 2px solid var(--accent);" : "color: #888;";
                html += `<button onclick="setActiveCase(${i})" style="background: #252526; ${activeStyle} border: 1px solid #444; padding: 4px 10px; cursor: pointer; font-size: 11px;">Case ${i+1}</button>`;
            });
            
            container.innerHTML = html + plusBtn;
        }

        function setActiveCase(index) {
            activeTestCaseIndex = index;
            renderTabs();
            renderInputs();
        }

        function renderInputs() {
            const container = document.getElementById('testcase-inputs');
            container.innerHTML = '';
            const currentCase = testCases[activeTestCaseIndex];
            
            currentCase.forEach((val, argIdx) => {
                const label = document.createElement('div');
                label.innerText = `Argument ${argIdx + 1}`;
                label.style = "font-size: 10px; color: #666; margin-bottom: 2px;";
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = JSON.stringify(val);

                
                input.onchange = (e) => {
                    try {
                        testCases[activeTestCaseIndex][argIdx] = JSON.parse(e.target.value);
                    } catch(err) {
                        alert("Invalid JSON input!");
                    }
                };
                container.appendChild(label);
                container.appendChild(input);
            });
        }

        function addTestCase() {
            if (testCases.length === 0) return;
            const newCase = JSON.parse(JSON.stringify(testCases[0])); 
            testCases.push(newCase);
            activeTestCaseIndex = testCases.length - 1;
            renderTabs();
            renderInputs();
        }

        async function runTests() {
            if (!currentFilepath) return;
            const out = document.getElementById('console-output');
            out.innerText = "[System] Running tests...\n";

            try {
                const response = await fetch('/api/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        slug: currentSlug,
                        filepath: currentFilepath,
                        custom_testcases: testCases 
                    })
                });
                const data = await response.json();
                out.innerText = data.output;
            } catch (err) {
                out.innerText += "\n[Error] " + err;
            }
        }



        async function revealSolution() {
            if (!currentSlug) return;
            
            //show loading
            document.getElementById('solution-overlay').style.display = 'flex';
            document.getElementById('solution-overlay').innerHTML = "<span>Fetching...</span>";

            try {
                const response = await fetch(`/api/solution/${currentSlug}`);
                const data = await response.json();

                if (data.error) throw new Error(data.error);



                document.getElementById('solution-overlay').style.display = 'none';
                const codeBlock = document.getElementById('solution-code');
                const view = document.getElementById('solution-view');
                
                codeBlock.textContent = data.clean_code;
                view.style.display = 'block';
                
                codeBlock.removeAttribute('data-highlighted');
                hljs.highlightElement(codeBlock);

            } catch (err) {
                document.getElementById('solution-overlay').innerHTML = `<span style="color:red">Error: ${err.message}</span>`;
            }
        }

        //cool tab switching :D
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (tabName === 'console') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('console-tab').classList.add('active');
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('solution-tab').classList.add('active');
            }
        }

        let allProblems = [];
        let downloadedSlugs = new Set();


        async function initProblemList() {
            const listElement = document.getElementById('problem-list');
            try {
                const resp = await fetch('/api/problems');
                const data = await resp.json();
                if (data.error) throw new Error(data.error);

                all_problems_data = data.all || [];
                downloadedSlugs = new Set(data.downloaded || []);
                
                renderFilteredList(""); 
            } catch (err) {
                console.error("Offline or API Error:", err);
                listElement.innerHTML = "<div style='padding:20px; color:#ce9178;'>Offline Mode: Only cached problems available.</div>";
            }
        }

        function renderFilteredList(query) {
            const list = document.getElementById('problem-list');
            const queryLower = query.toLowerCase().trim();

            const filtered = all_problems_data.filter(p => 
                p.title.toLowerCase().includes(queryLower) || 
                p.titleSlug.toLowerCase().includes(queryLower)
            ).slice(0, 50);

            if (filtered.length === 0) {
                list.innerHTML = `<div style="padding:20px; color:#666;">No problems found ${query ? "matching '" + query + "'" : ""}.</div>`;
                return;
            }

            list.innerHTML = ""; 
            filtered.forEach(p => {
                const isDownloaded = downloadedSlugs.has(p.titleSlug);
                const item = document.createElement('div');
                item.className = `problem-item ${currentSlug === p.titleSlug ? 'active' : ''}`;
                
                item.innerHTML = `
                    <span class="status-icon">${isDownloaded ? '✔' : ''}</span>
                    <span style="color: ${getDiffColor(p.difficulty)}; margin-right: 5px;">●</span>
                    ${p.title}
                `;
                
                item.onclick = () => loadProblem(p.titleSlug, item);
                list.appendChild(item);
            });
        }

        function getDiffColor(diff) {
            if (diff === 'Easy') return '#4caf50';
            if (diff === 'Medium') return '#ffb74d';
            return '#f44336';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('global-search');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    renderFilteredList(e.target.value.trim());
                });
            }
            initProblemList(); 
        });

        async function openVSCode() {
            if (!currentFilepath) {
                alert("No file path found for this problem.");
                return;
            }

            try {
                const response = await fetch('/api/open', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filepath: currentFilepath }) // Send the path saved in loadProblem
                });
                
                const data = await response.json();
                if (data.error) {
                    alert("Error opening VS Code: " + data.error);
                }
            } catch (err) {
                console.error("Failed to open VS Code:", err);
            }
        }
    </script>
</body>
</html>